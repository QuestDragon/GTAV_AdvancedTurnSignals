# Advanced Turn Signals - Created By QuestDragon
Version: 1.2.4
## 作成した経緯
今日も多数の方向指示器Modがアップロードされていますが、その多くは点灯と消灯を手動で行うものだったり、方向指示器の音がなかったりするものがほとんどでしたので、スクリプト制作の練習も兼ねて作成してみました。

方向指示器の音に関してはゲーム側に一応用意されているのですが、すごく小さい音かつ、ほんの一部の車両でしか鳴らないので、方向指示器の音や方向指示器レバーの音がなる機能も開発しました。

## 機能
車の方向指示器を操作することができます。左折、右折、ハザードランプの点灯、消灯が可能です。

現実の車で採用されている方向指示器の挙動をできる限り再現しており、ハンドルを切って戻すと自動で方向指示器が消灯する機能が用意されています。（ハンドルの角度はiniファイルにて調整可能）

その他に、方向指示器と逆の方向にハンドルを回した際にも消灯するようになっていたり、方向指示器の点灯状態とハザードランプの点灯状態は独立しているなど、細部の挙動にもこだわっています。

低速走行時にハンドルを回すと、自動で方向指示器が点灯する機能もつけています。_（NoRainさんからのリクエスト）_

方向指示器に関する効果音を使用できます。 `scripts\AdvancedTurnSignals\TurnSignalSounds` フォルダにサンプルの各種効果音を同梱しています。xmlファイルを使用して車両ごとにカスタマイズすることも可能です。（iniファイルにて効果音の有効無効を切り替えられます）

スクリプトから送信される通知の表示言語は `scripts\AdvancedTurnSignals\Localization.ini` にて翻訳できます。

コントローラー操作にも対応しています。なお、コントローラーでの方向指示器操作を行わない方のために使用の有無をiniファイルから設定できるようになっています。_（stevensonjnrさん、dustybluesさんからのリクエスト）_

修飾キーや2つのコントローラーボタンを組み合わせることも可能です。_（Reldam88さんからのリクエスト）_

## 機能追加、フィードバックについて
制作者は初心者なので何かと至らないところがあると思います。

不具合等を発見しましたら、QuestDragonまでご連絡ください。

また、「こんな機能がほしい！」「ここはこうしてほしい！」という要望がありましたらご相談ください。

こちらもスクリプトModについて勉強したいので、ご意見や要望はいつでもお待ちしております。

## 開発環境
C#を使用しています。

ScriptHookV DotNetを使用しており、バージョンは3.6.0のNightly ビルド 57で開発しています。

> [!IMPORTANT]
> 現時点では3.7.0のNightlyビルドが公開されています。本スクリプトを使用する際は3.7.0のNightlyビルドを導入の上ご使用ください。

## インストール
以下から各種ファイルをダウンロードし、スクリプトMod本体はScriptsフォルダに、前提条件のファイルはGTA5.exeと同じフォルダにコピーしてください。

| [Advanced Turn Signals](https://github.com/QuestDragon/GTAV_AdvancedTurnSignals/releases/latest/download/AdvancedTurnSignals.zip) | [ScriptHookV](http://dev-c.com/gtav/scripthookv/) | [ScriptHookV DotNet 3.7.0 Nightly](https://github.com/scripthookvdotnet/scripthookvdotnet-nightly/releases/latest) |
| ------------- | ------------- | ------------- | 

## インストール時のSCRIPT HOOK V ERRORについて
ScriptHookV DotNet Nightlyビルドを導入してGTA5を起動すると、「SCRIPT HOOK V ERROR」が表示され、scriptsフォルダに導入されている.NETスクリプトのすべてが読み込まれない現象になることがあります。

これは、ScriptHookV DotNetの前提条件を満たしていないことが原因です。**Releaseビルドでは動いていても、Nightlyビルドでは動かないことがあります。**

そのため、今一度次のコンポーネントがインストールされているかご確認ください。

| [.NET Framework 4.8 （ランタイム、開発者パックの"両方"が必要です。）](https://dotnet.microsoft.com/download/dotnet-framework/net48) | [Visual C++ Redistributable for Visual Studio 2019 x64](https://support.microsoft.com/en-us/help/2977003/the-latest-supported-visual-c-downloads) |
| ------------- | ------------- |

## 各種設定
設定はiniファイルから行います。

基本的にiniファイル内にも説明を記述しているので困ることはないと思いますが、こちらにも記載しておきます。

### General
**Enabled**：本スクリプトの有効化と無効化を切り替えます。「*true*」で有効、「*false*」で無効になります。

**UseSound**：効果音の有効化と無効化を切り替えます。同じく「*true*」で有効、「*false*」で無効になります。ただし、音声ファイルが正しく用意されていない場合、スクリプトの動作は継続されますが本来音声ファイルが必要になる操作を行っても音声ファイルは再生されません。

**InterSound**：効果音の音声ファイルが見つからなかった場合に、デフォルトの音声ファイルを再生するかを切り替えます。同じく「*true*」で有効、「*false*」で無効になります。ただし、デフォルトの音声ファイルが設定されていないか、デフォルトの音声ファイルも存在しない場合は本来音声ファイルが必要になる操作を行っても音声ファイルは再生されません。

### Keys
AdvancedTurnSignalsで使用するキー設定を変更できます。

**Left**：左方向指示器切り替え

**LeftModifier**：左方向指示器切り替え修飾キー

**Right**：右方向指示器切り替え

**RightModifier**：右方向指示器切り替え修飾キー

**Hazard**：ハザードランプ切り替え

**HazardModifier**：ハザードランプ切り替え修飾キー

指定する文字列は[こちらのサイト](https://learn.microsoft.com/en-us/dotnet/api/system.windows.forms.keys?redirectedfrom=MSDN&view=windowsdesktop-7.0)をご確認ください。指定が正しくない場合、スクリプトModロード時に一時的にデフォルト設定が読み込まれます。

### Buttons
AdvancedTurnSignalsをコントローラーで使用する際のボタン設定を変更できます。

**UseButton**：コントローラーの使用切り替え

**Left**：左方向指示器切り替え

**LeftModifier**：左方向指示器切り替え修飾ボタン

**Right**：右方向指示器切り替え

**RightModifier**：右方向指示器切り替え修飾ボタン

**Hazard**：ハザードランプ切り替え

**HazardModifier**：ハザードランプ切り替え修飾ボタン

指定する文字列は次の文字列が使用できます。
指定が正しくない場合、スクリプトModロード時に一時的にデフォルト設定が読み込まれます。

| LB | LS | LT | PadDown | PadLeft | PadRight | PadUp | RB | RS | RT | A | B | Y | X | Select |
| ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |

### Autooff
方向指示器の自動消灯に関する設定が行なえます。

**Autooff**：有効化と無効化を切り替えます。「*true*」で有効、「*false*」で無効になります。ただし、設定条件が正しくない場合、スクリプトModロード時に一時的に無効になります。

**ReadyAngle**：方向指示器が自動消灯するために回さなければならないハンドルの最低角度です。この角度を超えてハンドルを切ると自動消灯機能が働くようになります。

**OffAngle**：方向指示器が自動消灯するハンドルの角度です。この角度までハンドルを戻すか、方向指示器と反対の方向へこの角度まで相対で回すと方向指示器が自動で消灯します。

**KeyboardComp**：キーボードなどの細かいハンドル操作ができない操作方法を用いてスクリプトModを使用する場合に有効にするオプションです。「*true*」で有効、「*false*」で無効にでき、有効にすると、方向指示器は指定したハンドル角度まで戻ると指定したミリ秒後に自動消灯するようになります。アナログコントローラー等をお使いの場合で指定したハンドル角度まで戻った際に即自動消灯したい場合はここを無効にします。

**AutooffDuration**：KeyboardCompが有効になっている状態でOffAngleの値まで戻った際に方向指示器を自動消灯する所要時間をミリ秒単位で指定できます。※約200ミリ秒以下にすると正常に動作しない可能性があります。即時自動消灯を行う場合はKeyboardCompを無効にしてください。

### Autoon
方向指示器の自動点灯に関する設定が行なえます。

**Autoon**：有効化と無効化を切り替えます。「*true*」で有効、「*false*」で無効になります。

**OnAngle**：方向指示器が自動点灯するために回さなければならないハンドルの角度です。ハンドルの角度がこの角度に達するとハンドルを回した方向の方向指示器が自動で点灯します。

**OnSpeed**：方向指示器が自動点灯する自車の最高速度です。この速度を下回っている状態で`OnAngle`の角度までハンドルを回すと方向指示器が自動で点灯します。

#### 角度について
GTA5におけるハンドルの最大角度は40度とのことです。40度までの値であればスクリプトModは自動消灯機能を正常に実行できると思います。

#### OnSpeedの速度について
スピードメーターModやダッシュボードの速度計に表示される数値とは合致しない可能性があります。そのため、おおよその値を設定してください。

## 使い方
### 本体編
iniファイルにて**Enabled**を*True*にしているとゲームロード時に自動で読み込まれ、有効になります。

乗り物に乗って、iniファイルに設定したキーを押すと方向指示器が作動します。（自転車やヘリコプターなど、一部の乗り物を除く）

**UseSound**を*True*にしていて、音声ファイルが `scripts\AdvancedTurnSignals\TurnSignalSounds` フォルダに正しく用意されている場合は効果音が再生されます。

**Autooff**を*True*にしていて、設定が正しい場合は右左折が終わると自動で方向指示器が消灯します。（バイクを除く）

**KeyboardComp**を*True*にしている場合はAutooffDurationで指定したミリ秒後に方向指示器が自動消灯します。

**Autoon**を*True*にしていて、条件を満たしている場合は方向指示器が自動点灯します。

### Localization.ini編
スクリプトModから送信されるメッセージの内容を編集できます。

文字の色を変更したり、太字にしたりすることができます。

キー側の文字（=より左側）は編集しないでください。スクリプトModが編集したメッセージを認識できなくなります。

メッセージの内容が読み込めない場合は一時的に該当メッセージ部分が英語表記になります。

### TurnSignalSoundSetup.xml編
再生する効果音の音声ファイルを指定できます。

コメントとしてxmlファイル側にも記述していますが、**DefaultSettings**のタグは削除しないでください。効果音が再生されなくなってしまいます。

各タグ内の音声ファイル名を編集することで再生する音声ファイルを変更することができます。

**DefaultSettings**タグの下にはサンプルとして車両ごとの音声ファイル設定を記述しています。あくまでもサンプルなので削除してしまっても構いません。

車両ごとに音声ファイルを指定する場合はサンプルで用意されているタグの構成を真似してください。（コピペがおすすめです）

各タグ（**SoundSetup**など）はサンプルと全く同じに書いていないとスクリプトModが読み込めませんのでご注意ください。

**Vehicles**タグ内の**Vehicle**タグは複数追加できます。同じ音声ファイルを複数の車両で再生したい場合は**Vehicle**タグを増やすだけで指定することができます。

**Sounds**タグは**TURN_LEVER_INTRO**、**TURN_LEVER_OUTRO**、**INDICATOR_SOUND**、**HAZARD_BUTTON**の計4つのタグを必ず書いてください。

再生したくない箇所がある場合はタグ名だけ書いておいてください。タグを丸ごと省略することはしないでください。（例：\<HAZARD_BUTTON /> または \<HAZARD_BUTTON>\</HAZARD_BUTTON>）

## 余談
ハンドルの角度で方向指示器を自動消灯するか判断しているので、ikt氏のManual Transmission Modにも対応させようかと思ったのですが、GTA5のアップデートによって使えなくなっていることが判明し、実装できませんでした…。

ScriptHookV DotNetのリリース版（3.6.0）では動作しない理由は、どうやら不具合でハンドル角度が取得できないようです。開発版のNightlyビルドでは修正されているので、こちらを使用する必要があります。

## 免責事項
本スクリプトModを使用したことにより生じた被害に関して、私QuestDragonは一切の責任を負いかねます。自己責任でご使用ください。

ファイルに一切変更を加えない状態での2次配布は禁止です。

予告なく配布を停止することがあります。予めご了承ください。

改造はご自由にしていただいて構いませんが、配布の際はクレジット表記していただけると助かります。

「一から自作した」というのではなく、「QuestDragonのスクリプト(Advanced Turn Signals)の〇〇を△△にした」のように表記していただければと思います。

## 制作者
QuestDragon
